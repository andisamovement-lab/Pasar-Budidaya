<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pasar Budidaya — Menghubungkan petani dan peternak ke khalayak ramai</title>
<meta name="description" content="Pasar Budidaya — marketplace sederhana untuk menghubungkan petani & peternak dengan pembeli.">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
<style>
.social-btn { display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .5rem; border-radius:.45rem; font-size:10px; text-decoration:none; }
.insta-grad {
  background: radial-gradient(circle at 30% 30%, #fccc63 0%, transparent 15%),
              linear-gradient(45deg,#f58529,#dd2a7b 30%,#8134af 60%,#515bd4 100%);
  -webkit-background-clip: padding-box;
  color: white;
}
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getDatabase, ref, set, push, get, child, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

// === KONFIGURASI FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyB05CpkJHltmM7yh3J3NzvJ8HJYOy4d0s8",
  authDomain: "pasar-budidaya.firebaseapp.com",
  databaseURL: "https://pasar-budidaya-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "pasar-budidaya",
  storageBucket: "pasar-budidaya.firebasestorage.app",
  messagingSenderId: "1019549141667",
  appId: "1:1019549141667:web:1e8493a34efe180dbe8d16"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Global helper
window.db=db; window.auth=auth;
window.ref=ref; window.push=push; window.get=get; window.child=child; window.set=set; window.remove=remove;
window.signInWithEmailAndPassword=signInWithEmailAndPassword; window.signOut=signOut;
</script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

<header id="siteHeader" class="bg-white shadow-sm fixed top-0 left-0 w-full z-50">
<div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-2">
  <div class="flex justify-start">
    <button id="adminBtn" class="px-1 py-0.5 text-[10px] rounded border border-green-600 text-green-600 hover:bg-green-50">Admin</button>
  </div>
  <div class="flex flex-col items-center gap-2">
    <img src="https://iili.io/K0Uz11e.md.png" alt="Logo Pasar Budidaya" class="w-20 h-20 object-contain" crossorigin="anonymous">
    <div class="text-2xl font-bold" style="font-family: Montserrat">Pasar Budidaya</div>
    <div class="text-xs text-gray-600 text-center">Menghubungkan petani dan peternak ke khalayak ramai</div>
  </div>
  <div class="flex items-center gap-3 w-full md:w-auto justify-end">
    <input id="searchInput" type="search" placeholder="Cari: judul, deskripsi, kecamatan..." class="flex-1 md:w-72 px-3 py-2 border rounded-lg text-sm" />
    <button id="searchBtn" class="px-4 py-2 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700">Cari</button>
  </div>
</div>
</header>

<main id="mainContent" class="max-w-6xl mx-auto px-4 py-8 flex-1 w-full">
<section class="mb-6">
<h2 class="text-xl font-semibold mb-2">Daftar Petani & Peternak</h2>
<p class="text-sm text-gray-600 mb-4">Lihat produk, kontak via WhatsApp / Facebook / Instagram.</p>
</section>
<section id="listArea" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></section>
</main>

<footer class="bg-gray-800 text-white py-4 ">
<div class="max-w-6xl mx-auto px-4 text-center text-sm">&copy; 2025 Andisa Movement. Untuk info lebih lanjut hubungi 0831-6159-3659.</div>
</footer>

<!-- LOGIN & ADMIN MODAL -->
<div id="loginModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
<div class="bg-white rounded-lg shadow-lg w-full max-w-md p-4">
<div class="flex justify-between items-center mb-3">
<h3 class="text-lg font-semibold">Admin Login</h3>
<button id="closeLogin" class="text-gray-500 hover:text-gray-700">×</button>
</div>
<form id="loginForm" class="space-y-3">
<div>
<label class="text-xs text-gray-600">Email</label>
<input id="loginEmail" type="email" class="w-full mt-1 px-3 py-2 border rounded" placeholder="email" required />
</div>
<div>
<label class="text-xs text-gray-600">Password</label>
<input id="loginPassword" type="password" class="w-full mt-1 px-3 py-2 border rounded" placeholder="password" required />
</div>
<button type="submit" class="w-full py-2 px-4 bg-green-600 text-white rounded hover:bg-green-700">Login</button>
</form>
</div>
</div>

<div id="adminModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
<div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-4 overflow-y-auto max-h-[90vh]">
<div class="flex justify-between items-center mb-3">
<h3 class="text-lg font-semibold">Admin Panel</h3>
<input id="adminSearchInput" type="text" placeholder="Cari listing..." class="px-2 py-1 border rounded text-sm w-1/2">
<button id="closeAdmin" class="text-gray-500 hover:text-gray-700">×</button>
</div>
<form id="listingForm" class="space-y-3">
<div><label class="text-xs text-gray-600">Judul</label><input id="listingTitle" type="text" class="w-full mt-1 px-3 py-2 border rounded" required></div>
<div><label class="text-xs text-gray-600">Deskripsi</label><textarea id="listingDesc" class="w-full mt-1 px-3 py-2 border rounded" required></textarea></div>
<div><label class="text-xs text-gray-600">Kecamatan</label><input id="listingKec" type="text" class="w-full mt-1 px-3 py-2 border rounded" required></div>
<div><label class="text-xs text-gray-600">Harga</label><input id="listingPrice" type="text" class="w-full mt-1 px-3 py-2 border rounded" required></div>
<div><label class="text-xs text-gray-600">WhatsApp</label><input id="listingWA" type="text" class="w-full mt-1 px-3 py-2 border rounded"></div>
<div><label class="text-xs text-gray-600">Facebook</label><input id="listingFB" type="text" class="w-full mt-1 px-3 py-2 border rounded"></div>
<div><label class="text-xs text-gray-600">Instagram</label><input id="listingIG" type="text" class="w-full mt-1 px-3 py-2 border rounded"></div>
<div><label class="text-xs text-gray-600">Gambar</label><input id="listingImage" type="file" accept="image/*" class="w-full mt-1 px-3 py-2 border rounded"></div>
<input type="hidden" id="editingKey" value="">
<button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan Listing</button>

<div id="progressContainer" class="hidden w-full mt-1">
  <div id="progressText" class="text-[5px] text-gray-600 mb-1">Menunggu...</div>
  <div class="w-full bg-gray-200 rounded-full h-2.5">
    <div id="progressBar" class="bg-green-500 h-2.5 rounded-full text-[10px] text-white text-center" style="width:0%">0%</div>
  </div>
</div>
</form>
<hr class="my-4">
<div id="adminListArea" class="space-y-2"></div>
</div>
</div>

<script type="module">
// ======= HELPER =======
function sanitizeHTML(str){ const div=document.createElement('div'); div.textContent=str; return div.innerHTML; }
function normalizeFacebookUrl(url){ if(!url) return ''; if(!url.includes('facebook.com')) url='https://facebook.com/'+url.replace('@',''); return url; }
function sanitizeInstagramUsername(user){ if(!user) return ''; return user.replace('@','').trim(); }
function sanitizePhoneNumber(num){ if(!num) return ''; return num.replace(/\D/g,''); }

// ======= LOGIN =======
const loginModal=document.getElementById('loginModal');
document.getElementById('adminBtn').addEventListener('click',()=>loginModal.classList.remove('hidden'));
document.getElementById('closeLogin').addEventListener('click',()=>loginModal.classList.add('hidden'));

const loginForm=document.getElementById('loginForm');
loginForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const email=document.getElementById('loginEmail').value;
  const password=document.getElementById('loginPassword').value;
  try{
    const userCred = await signInWithEmailAndPassword(auth,email,password);
    sessionStorage.setItem('pasarbudidaya.admin',userCred.user.uid);
    loginModal.classList.add('hidden');
    openAdminPanel();
  }catch(err){ alert('Login gagal: '+err.message); }
});

// ======= ADMIN PANEL =======
const adminModal=document.getElementById('adminModal');
document.getElementById('closeAdmin').addEventListener('click',()=>adminModal.classList.add('hidden'));
let localAdminData={}; // simpan data lokal
function openAdminPanel(){ adminModal.classList.remove('hidden'); loadAdminList(); }

// ======= CLOUDINARY UPLOAD =======
async function uploadToCloudinary(file, progressCallback){
  return new Promise((resolve,reject)=>{
    const MAX_SIZE = 2*1024*1024;
    if(file.size > MAX_SIZE){ reject("Ukuran file terlalu besar. Maks 2MB"); return; }
    const url = "https://api.cloudinary.com/v1_1/doju1f65q/image/upload";
    const preset = "pasar_budidaya";
    const formData = new FormData();
    formData.append("file",file);
    formData.append("upload_preset",preset);
    const xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.upload.onprogress = (e) => {
      if(e.lengthComputable && progressCallback){
        const percent = Math.round((e.loaded / e.total) * 50); // 0-50%
        progressCallback(percent);
      }
    };
    xhr.onload = ()=> {
      if(xhr.status>=200 && xhr.status<300){
        try{ resolve(JSON.parse(xhr.responseText).secure_url); } catch(err){ reject("Parse response error"); }
      } else reject("Upload gagal: "+xhr.statusText);
    };
    xhr.onerror=()=>reject("Upload error");
    xhr.send(formData);
  });
}

// ======= ADD / EDIT LISTING =======
const listingForm=document.getElementById('listingForm');
const progressContainer=document.getElementById('progressContainer');
const progressBar=document.getElementById('progressBar');
const progressText=document.getElementById('progressText');

function updateProgress(val,text){ progressBar.style.width=val+'%'; progressBar.textContent=val+'%'; if(text) progressText.textContent=text; }

listingForm.addEventListener('submit', async e => {
  e.preventDefault();
  updateProgress(0,'Memulai...');
  progressContainer.classList.remove('hidden');

  const title = sanitizeHTML(document.getElementById('listingTitle').value);
  const description = sanitizeHTML(document.getElementById('listingDesc').value);
  const kecamatan = sanitizeHTML(document.getElementById('listingKec').value);
  const price = sanitizeHTML(document.getElementById('listingPrice').value);
  const whatsapp = sanitizePhoneNumber(document.getElementById('listingWA').value);
  const facebook = normalizeFacebookUrl(document.getElementById('listingFB').value);
  const instagram = sanitizeInstagramUsername(document.getElementById('listingIG').value);
  const imageFile = document.getElementById('listingImage').files[0];
  let imageUrl = null;

  try{
    if(imageFile){
      updateProgress(0,'Upload gambar...');
      imageUrl = await uploadToCloudinary(imageFile,(percent)=>{ updateProgress(Math.round(percent*0.8),'Upload gambar...'); });
    }

    updateProgress(80,'Menyimpan data ke database...');
    const editingKey = document.getElementById('editingKey').value;
    const data = { title, description, kecamatan, price };
    if(whatsapp) data.whatsapp=whatsapp;
    if(facebook) data.facebook=facebook;
    if(instagram) data.instagram=instagram;
    if(imageUrl) data.imageUrl=imageUrl;

    let key=null;
    if(editingKey){ await set(ref(db,'listings/'+editingKey),data); key=editingKey; localAdminData[key]=data; }
    else{ const newRef=await push(ref(db,'listings'),data); key=newRef.key; localAdminData[key]=data; }

    updateProgress(100,'Selesai');
    setTimeout(()=>{ progressContainer.classList.add('hidden'); updateProgress(0,''); },500);

    alert('Listing berhasil disimpan!');
    listingForm.reset();
    document.getElementById('editingKey').value='';
    renderAdminList();
    renderPublicList();

  }catch(err){ console.error(err); alert('Gagal simpan listing: '+err); progressContainer.classList.add('hidden'); updateProgress(0,''); }
});

// ======= LOAD ADMIN LIST =======
async function loadAdminList(){
  const snap = await get(ref(db,'listings'));
  localAdminData = snap.exists()?snap.val():{};
  renderAdminList();
}
function renderAdminList(){
  const area=document.getElementById('adminListArea'); area.innerHTML='';
  Object.keys(localAdminData).forEach(key=>{
    const item=localAdminData[key];
    const div=document.createElement('div');
    div.className='border rounded p-2 flex justify-between items-center';
    div.innerHTML=`<span>${sanitizeHTML(item.title)}</span>
      <div class="flex gap-1">
        <button class="px-2 py-1 bg-yellow-400 text-white rounded text-xs editBtn">Edit</button>
        <button class="px-2 py-1 bg-red-600 text-white rounded text-xs deleteBtn">Hapus</button>
      </div>`;
    div.querySelector('.editBtn').addEventListener('click',()=>{
      document.getElementById('listingTitle').value=item.title;
      document.getElementById('listingDesc').value=item.description;
      document.getElementById('listingKec').value=item.kecamatan;
      document.getElementById('listingPrice').value=item.price;
      document.getElementById('listingWA').value=item.whatsapp;
      document.getElementById('listingFB').value=item.facebook;
      document.getElementById('listingIG').value=item.instagram;
      document.getElementById('editingKey').value=key;
    });
    div.querySelector('.deleteBtn').addEventListener('click',async ()=>{
      if(confirm("Hapus listing ini?")){
        await remove(ref(db,'listings/'+key));
        delete localAdminData[key];
        renderAdminList();
        renderPublicList();
      }
    });
    area.appendChild(div);
  });
}

// ======= ADMIN SEARCH =======
document.getElementById('adminSearchInput').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase();
  const area=document.getElementById('adminListArea'); area.innerHTML='';
  Object.keys(localAdminData).filter(k=>localAdminData[k].title.toLowerCase().includes(q) || localAdminData[k].description.toLowerCase().includes(q) || localAdminData[k].kecamatan.toLowerCase().includes(q))
  .forEach(key=>{
    const item=localAdminData[key];
    const div=document.createElement('div');
    div.className='border rounded p-2 flex justify-between items-center';
    div.innerHTML=`<span>${sanitizeHTML(item.title)}</span>
      <div class="flex gap-1">
        <button class="px-2 py-1 bg-yellow-400 text-white rounded text-xs editBtn">Edit</button>
        <button class="px-2 py-1 bg-red-600 text-white rounded text-xs deleteBtn">Hapus</button>
      </div>`;
    div.querySelector('.editBtn').addEventListener('click',()=>{
      document.getElementById('listingTitle').value=item.title;
      document.getElementById('listingDesc').value=item.description;
      document.getElementById('listingKec').value=item.kecamatan;
      document.getElementById('listingPrice').value=item.price;
      document.getElementById('listingWA').value=item.whatsapp;
      document.getElementById('listingFB').value=item.facebook;
      document.getElementById('listingIG').value=item.instagram;
      document.getElementById('editingKey').value=key;
    });
    div.querySelector('.deleteBtn').addEventListener('click',async ()=>{
      if(confirm("Hapus listing ini?")){
        await remove(ref(db,'listings/'+key));
        delete localAdminData[key];
        renderAdminList();
        renderPublicList();
      }
    });
    area.appendChild(div);
  });
});

// ======= PUBLIC LIST RENDER =======
function renderPublicList(){
  const area=document.getElementById('listArea'); area.innerHTML='';
  Object.keys(localAdminData).forEach(key=>{
    const item=localAdminData[key];
    const div=document.createElement('div');
    div.className='border rounded p-3 bg-white shadow-sm flex flex-col gap-1';
    div.innerHTML=`
      ${item.imageUrl?`<img src="${item.imageUrl}" class="w-full h-32 object-cover rounded">`:''}
      <div class="font-semibold">${sanitizeHTML(item.title)}</div>
      <div class="text-sm text-gray-600">${sanitizeHTML(item.description)}</div>
      <div class="text-sm font-bold">Harga: ${sanitizeHTML(item.price)}</div>
      <div class="flex gap-2 text-xs mt-1">
        ${item.whatsapp?`<a href="https://wa.me/${item.whatsapp}" target="_blank" class="px-2 py-1 bg-green-500 text-white rounded">WA</a>`:''}
        ${item.facebook?`<a href="${item.facebook}" target="_blank" class="px-2 py-1 bg-blue-600 text-white rounded">FB</a>`:''}
        ${item.instagram?`<a href="https://instagram.com/${item.instagram}" target="_blank" class="px-2 py-1 insta-grad rounded">IG</a>`:''}
      </div>`;
    area.appendChild(div);
  });
}

// ======= INIT =======
window.addEventListener('load',async ()=>{
  const snap = await get(ref(db,'listings'));
  localAdminData = snap.exists()?snap.val():{};
  renderPublicList();
});
</script>
</body>
</html>
